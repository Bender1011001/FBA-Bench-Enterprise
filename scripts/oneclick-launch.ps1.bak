# oneclick-launch.ps1 â€” exit-code based, UTF-8 logs, builds+starts redis/api/web

$ErrorActionPreference = 'Stop'
try { [Console]::OutputEncoding = [Text.Encoding]::UTF8 } catch {}
$OutputEncoding = [Text.Encoding]::UTF8
$PSDefaultParameterValues['Out-File:Encoding']    = 'utf8'
$PSDefaultParameterValues['Add-Content:Encoding'] = 'utf8'
$PSDefaultParameterValues['Set-Content:Encoding'] = 'utf8'
$env:BUILDKIT_PROGRESS = 'plain'
$env:NO_COLOR          = '1'

# ---- logging ----
$LogDir  = Join-Path $env:USERPROFILE '.fba\logs'
$null = New-Item -ItemType Directory -Force -Path $LogDir | Out-Null
$LogFile = Join-Path $LogDir ("oneclick-{0}.log" -f (Get-Date -Format 'yyyyMMdd-HHmmss'))

function Log([string]$lvl,[string]$msg) {
  $line = "[{0}] {1} {2}" -f ((Get-Date).ToString('o')), $lvl, $msg
  Write-Host $line
  $line | Add-Content -Path $LogFile -Encoding utf8
}
function Info($m){ Log 'INFO'  $m }
function Warn($m){ Log 'WARN'  $m }
function Err ($m){ Log 'ERROR' $m }

# ---- repo root detection ----
$__scriptFile = if ($PSCommandPath) { $PSCommandPath } elseif ($MyInvocation.MyCommand.Path) { $MyInvocation.MyCommand.Path } else { $null }
$__scriptDir  = if ($PSScriptRoot)  { $PSScriptRoot }  elseif ($__scriptFile)              { [IO.Path]::GetDirectoryName($__scriptFile) } else { (Get-Location).Path }
$repoRoot = (& git -C $__scriptDir rev-parse --show-toplevel 2>$null); if (-not $repoRoot) { $repoRoot = $__scriptDir }
$repoRoot = [IO.Path]::GetFullPath($repoRoot)

Info "Starting one-click launch"
Info "Repo root: $repoRoot"

# ---- compose file selection (fixed) ----
$composeCandidates = @(
  (Join-Path $repoRoot 'docker-compose.oneclick.yml'),
  (Join-Path $repoRoot 'docker-compose.yml')
)
$composeFile = $composeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
if (-not $composeFile) {
  Err "No compose file found. Looked for: $($composeCandidates -join ', ')"
  exit 2
}
Info "Compose file: $composeFile"

Push-Location $repoRoot
try {
  $composeArgs = @('--ansi','never','-f', $composeFile)

  Info "Building images: redis, api, web"
  $null = & docker compose @composeArgs build redis api web 2>&1
  if ($LASTEXITCODE) { Err "docker compose build failed (exit $LASTEXITCODE)"; exit $LASTEXITCODE }
  Info "Build OK"

  Info "Starting services"
  $null = & docker compose @composeArgs up -d 2>&1
  if ($LASTEXITCODE) { Err "docker compose up failed (exit $LASTEXITCODE)"; exit $LASTEXITCODE }
  Info "Services started"

  & docker compose -f $composeFile ps | ForEach-Object { Info $_ }

  # optional readiness probe
  $health = 'http://localhost:8080/api/healthz'
  $ok = $false
  foreach ($i in 1..60) {
    try {
      $r = Invoke-WebRequest -UseBasicParsing -Uri $health -TimeoutSec 3
      if ($r.StatusCode -ge 200 -and $r.StatusCode -lt 300) { $ok = $true; break }
    } catch {}
    Start-Sleep 1
  }
  if ($ok) { Info "API ready at $health" } else { Warn "API not responding at $health (may still be starting)" }
  Info "Open http://localhost:8080"
}
finally {
  Pop-Location
}
