<![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<common_patterns>
  <overview>
    Reusable patterns for translating natural language to FBA-Bench Enterprise operations.
    These include common NL phrases, corresponding commands, and execution sequences.
    Use these to standardize responses and ensure consistency.
  </overview>

  <nl_to_command_patterns>
    <pattern name="setup_install">
      <description>Handle installation and dependency setup requests.</description>
      <nl_phrases>
        <phrase>"install dependencies"</phrase>
        <phrase>"set up project"</phrase>
        <phrase>"pip install"</phrase>
      </nl_phrases>
      <command_template>pip install -r requirements.txt && pip install -e ../fba-bench-core</command_template>
      <pre_steps>
        <step>Check if venv active: execute_command "python -c 'import sys; print(sys.executable)'" to verify.</step>
      </pre_steps>
      <example>
        <nl_input>"Install the project dependencies"</nl_input>
        <action>execute_command: "pip install -r requirements.txt && pip install -e ../fba-bench-core"</action>
        <expected_output>Success: "Successfully installed..." or error: suggest venv.</expected_output>
      </example>
    </pattern>

    <pattern name="db_migrate">
      <description>Database migration and bootstrap.</description>
      <nl_phrases>
        <phrase>"run migrations"</phrase>
        <phrase>"set up database"</phrase>
        <phrase>"alembic upgrade"</phrase>
      </nl_phrases>
      <command_template>alembic upgrade head</command_template>
      <pre_steps>
        <step>Ensure .env copied: read_file .env.example, suggest copy if missing.</step>
        <step>Check current: alembic current.</step>
      </pre_steps>
      <example>
        <nl_input>"Migrate the database"</nl_input>
        <action>execute_command: "alembic upgrade head"</action>
        <expected_output>Output: "INFO [alembic.runtime.migration] Running upgrade..."</expected_output>
      </example>
    </pattern>

    <pattern name="start_server">
      <description>Start backend API or frontend dev server.</description>
      <nl_phrases>
        <phrase>"start API"</phrase>
        <phrase>"run server"</phrase>
        <phrase>"uvicorn"</phrase>
        <phrase>"start frontend"</phrase>
        <phrase>"npm dev"</phrase>
      </nl_phrases>
      <command_templates>
        <template type="backend">uvicorn api.server:app --reload --host 0.0.0.0 --port 8000</template>
        <template type="frontend">cd web && npm install && npm run dev</template>
      </command_templates>
      <pre_steps>
        <step>For backend: Verify migrations run.</step>
        <step>For frontend: Check node_modules via list_files web/.</step>
      </pre_steps>
      <example>
        <nl_input>"Start the development server"</nl_input>
        <action>Clarify: ask_followup_question "Backend API or frontend?" suggests: "Backend API", "Frontend web app", "Both".</action>
        <action>Backend: execute_command "uvicorn api.server:app --reload"</action>
        <expected_output>"Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)"</expected_output>
      </example>
    </pattern>

    <pattern name="run_tests">
      <description>Execute unit/integration tests.</description>
      <nl_phrases>
        <phrase>"run tests"</phrase>
        <phrase>"pytest"</phrase>
        <phrase>"test auth"</phrase>
        <phrase>"npm test"</phrase>
      </nl_phrases>
      <command_templates>
        <template type="backend">pytest tests/ -q --cov=api</template>
        <template type="frontend">cd web && npm test</template>
        <template type="integration">python integration_tests/run_integration_tests.py</template>
      </command_templates>
      <example>
        <nl_input>"Test the authentication endpoints"</nl_input>
        <action>execute_command: "pytest tests/test_auth_*.py -q"</action>
        <expected_output>"All tests passed" or failures with traces.</expected_output>
      </example>
    </pattern>

    <pattern name="provision_tenant">
      <description>Infra provisioning for tenants/sandboxes.</description>
      <nl_phrases>
        <phrase>"provision tenant"</phrase>
        <phrase>"create demo sandbox"</phrase>
        <phrase>"terraform plan"</phrase>
      </nl_phrases>
      <command_sequence>
        <step>generate: infrastructure/scripts/generate_tenant_configs.py --tenant={name}</step>
        <step>provision: infrastructure/scripts/provision_demo_tenant.sh --tenant={name}</step>
        <step>plan: cd infrastructure/terraform && terraform plan -var-file=../tenants/{name}/terraform.tfvars</step>
      </command_sequence>
      <pre_steps>
        <step>Ask for tenant name: default "demo".</step>
        <step>Dry-run only unless confirmed.</step>
      </pre_steps>
      <example>
        <nl_input>"Generate a demo tenant"</nl_input>
        <action>execute_command: "infrastructure/scripts/generate_tenant_configs.py --tenant=demo"</action>
        <action>Then: "infrastructure/scripts/provision_demo_tenant.sh --tenant=demo"</action>
        <expected_output>Files created in tenants/demo/; plan output shown.</expected_output>
      </example>
    </pattern>

    <pattern name="redteam_test">
      <description>Run red-team adversarial tests.</description>
      <nl_phrases>
        <phrase>"run red team test"</phrase>
        <phrase>"test exploit"</phrase>
        <phrase>"gauntlet"</phrase>
      </nl_phrases>
      <command_template>python src/redteam/gauntlet_runner.py --exploit {path}</command_template>
      <pre_steps>
        <step>List examples: list_files redteam_scripts/examples/.</step>
        <step>Default: compliance_trap_fake_policy_v1.0.0.yaml.</step>
      </pre_steps>
      <example>
        <nl_input>"Run a phishing exploit test"</nl_input>
        <action>execute_command: "python src/redteam/gauntlet_runner.py --exploit redteam_scripts/examples/phishing_supplier_impersonation_v1.0.0.yaml"</action>
        <expected_output>Resistance score and logs.</expected_output>
      </example>
    </pattern>

    <pattern name="docker_stack">
      <description>Manage Docker Compose stacks.</description>
      <nl_phrases>
        <phrase>"start docker"</phrase>
        <phrase>"docker compose up"</phrase>
        <phrase>"run dev stack"</phrase>
      </nl_phrases>
      <command_templates>
        <template type="dev">docker compose -f docker-compose.dev.yml up -d</template>
        <template type="full">docker compose -f docker-compose.full.yml up -d</template>
        <template type="down">docker compose down</template>
      </command_templates>
      <example>
        <nl_input>"Start the development Docker stack"</nl_input>
        <action>execute_command: "docker compose -f docker-compose.dev.yml up -d"</action>
        <expected_output>Containers started: API, DB, Redis.</expected_output>
      </example>
    </pattern>
  </nl_to_command_patterns>

  <sequence_patterns>
    <pattern name="full_setup">
      <description>Complete project setup sequence.</description>
      <sequence>
        <step>1. Install deps (pip).</step>
        <step>2. Copy .env.example to .env.</step>
        <step>3. Run migrations (alembic).</step>
        <step>4. Smoke test (user_store).</step>
        <step>5. Start API (uvicorn).</step>
      </sequence>
      <when_to_use>NL like "set up everything from scratch".</when_to_use>
    </pattern>

    <pattern name="demo_flow">
      <description>Sales demo sequence (from RUNBOOK_DEMO.md).</description>
      <sequence>
        <step>1. Start backend (uvicorn).</step>
        <step>2. Start web (npm dev).</step>
        <step>3. Register/login via curl or UI.</step>
        <step>4. Provision demo tenant (dry-run).</step>
      </sequence>
      <when_to_use>NL like "run the sales demo".</when_to_use>
    </pattern>
  </sequence_patterns>

  <project_specific_patterns>
    <pattern name="env_edit">
      <description>Safe .env modifications.</description>
      <search_replace>
        <search>STRIPE_SECRET_KEY=.*</search>
        <replace>STRIPE_SECRET_KEY=sk_test_your_key_here</replace>
      </search_replace>
      <when_to_use>Update configs without full rewrite.</when_to_use>
    </pattern>

    <pattern name="core_import_check">
      <description>Verify core integration.</description>
      <command>python -c "import fba_bench_core.services.dashboard_api_service; print('Core OK')"</command>
      <when_to_use>Before sim-related actions.</when_to_use>
    </pattern>
  </project_specific_patterns>
</common_patterns>]]>