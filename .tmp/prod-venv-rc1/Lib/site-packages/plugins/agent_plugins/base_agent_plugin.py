import logging
from typing import Any, Dict, Protocol

logger = logging.getLogger(__name__)


class AgentPlugin(Protocol):
    """
    Base interface for agent plugins used for type checking and consistency.
    Implementations should inherit from BaseAgentPlugin or implement this protocol.
    """

    __is_fba_plugin__: bool
    plugin_id: str
    version: str
    name: str
    description: str
    agent_type: str  # e.g., "rule_based", "learning_agent", "llm_agent"

    def initialize(self, config: Dict[str, Any]) -> None: ...
    async def decide_action(
        self, current_state: Dict[str, Any], context: Dict[str, Any]
    ) -> Dict[str, Any]: ...
    async def learn_from_experience(self, episode_experience: Dict[str, Any]) -> None: ...
    def get_plugin_info(self) -> Dict[str, Any]: ...
    def get_performance_benchmarks(self) -> Dict[str, Any]: ...
    def get_sharing_mechanism_info(self) -> Dict[str, Any]: ...


class BaseAgentPlugin:
    """
    Concrete base class for agent plugins. New plugins should inherit from this class
    to ensure compatibility with the FBA-Bench plugin framework.
    """

    __is_fba_plugin__ = True
    plugin_id: str = "base_agent_plugin"
    version: str = "0.1.0"
    name: str = "Base Agent Plugin"
    description: str = "A base class for creating FBA-Bench custom agents."
    agent_type: str = "general"

    def initialize(self, config: Dict[str, Any]) -> None:
        logger.info(
            "Initializing AgentPlugin: %s with config keys: %s",
            self.name,
            list(config.keys()) if isinstance(config, dict) else type(config),
        )

    async def decide_action(
        self, current_state: Dict[str, Any], context: Dict[str, Any]
    ) -> Dict[str, Any]:
        logger.info(
            "Agent %s making decision based on state keys: %s",
            self.name,
            list(current_state.keys()),
        )
        current_price = current_state.get("price", 10.0)
        current_inventory = current_state.get("inventory", 100)
        if current_inventory < 20:
            logger.info(
                "Agent %s: Low inventory (%s), ordering more.", self.name, current_inventory
            )
            return {"type": "adjust_inventory", "value": 50}
        if current_state.get("demand", 0) > 80 and current_price < 20.0:
            logger.info("Agent %s: High demand, increasing price.", self.name)
            return {"type": "set_price", "value": current_price * 1.05}
        return {"type": "no_action"}

    async def learn_from_experience(self, episode_experience: Dict[str, Any]) -> None:
        logger.info(
            "Agent %s learning from episode experience keys: %s",
            self.name,
            list(episode_experience.keys()),
        )
        outcomes = episode_experience.get("outcomes", {})
        if outcomes.get("profit") and outcomes["profit"] < 0:
            logger.warning(
                "Agent %s: Learned from negative profit episode. Adjusting strategy.", self.name
            )
        else:
            logger.info(
                "Agent %s: Episode was neutral or positive. Reinforcing strategy.", self.name
            )

    def get_plugin_info(self) -> Dict[str, Any]:
        return {
            "plugin_id": self.plugin_id,
            "name": self.name,
            "version": self.version,
            "description": self.description,
            "agent_type": self.agent_type,
            "supported_actions": ["set_price", "adjust_inventory"],
        }

    def get_performance_benchmarks(self) -> Dict[str, Any]:
        logger.info("Retrieving performance benchmarks for AgentPlugin: %s", self.name)
        return {
            "average_profit_per_episode": 1500.0,
            "inventory_turnover_rate": 3.5,
            "decision_latency_ms": 50,
            "evaluation_episodes_run": 100,
        }

    def get_sharing_mechanism_info(self) -> Dict[str, Any]:
        """
        Provides information on how this agent's strategy can be shared or distributed.
        """
        logger.info("Retrieving sharing mechanism info for AgentPlugin: %s", self.name)
        return {
            "export_format": "JSON_config",
            "dependencies": ["numpy"],
            "licensing": "MIT",
            "contribution_guidelines": "See FBA-Bench docs on agent contribution.",
        }


# -----------------------------------------------------------------------------
# Plugin Agent Registration Interface (Documentation)
# -----------------------------------------------------------------------------
# Plugins can optionally provide a `register_agents(registry)` method that the
# PluginManager will invoke after plugin initialization. Use this to register
# your agents with the core AgentRegistry.
#
# Example:
#
# from benchmarking.agents.registry import AgentDescriptor
#
# class MyAgentPlugin(AgentPlugin):
#     __is_fba_plugin__ = True
#     plugin_id = "my_agent_plugin"
#     version = "1.0.0"
#     name = "My Agent Plugin"
#
#     def register_agents(self, registry):
#         class MyAgentClass:
#             def __init__(self, config=None):
#                 self.config = config
#
#         registry.register_agent(AgentDescriptor(
#             slug="my_agent",
#             display_name="My Agent",
#             constructor=MyAgentClass,
#             version="1.0.0",
#             provenance="plugin",
#             supported_capabilities=["decision_making"],
#             tags=["example", "plugin"],
#             help="Example plugin-registered agent",
#         ))
