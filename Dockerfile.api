FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app
# Ensure all repo-root packages/modules (e.g., agents, llm_interface, constraints, event_bus.py) are importable in runtime and tests
ENV PYTHONPATH=/app

# Minimal build deps for installing wheels when needed
RUN apt-get update && apt-get install -y --no-install-recommends build-essential ca-certificates && rm -rf /var/lib/apt/lists/*

# Copy project files
COPY pyproject.toml README.md ./
COPY fba_bench ./fba_bench
COPY fba_bench_api ./fba_bench_api
COPY agent_runners ./agent_runners
COPY benchmarking ./benchmarking
COPY observability ./observability
COPY services ./services
COPY models ./models
COPY metrics ./metrics
COPY memory_experiments ./memory_experiments
COPY reproducibility ./reproducibility
COPY redteam ./redteam
COPY scenarios ./scenarios
COPY plugins ./plugins
COPY fba_events ./fba_events

# Additional top-level packages required by tests and runtime
COPY agents ./agents
COPY constraints ./constraints
COPY infrastructure ./infrastructure
COPY instrumentation ./instrumentation
COPY learning ./learning
COPY llm_interface ./llm_interface
COPY baseline_bots ./baseline_bots
COPY tools ./tools
COPY config ./config
COPY api ./api
COPY community ./community

# Root-level modules used by tests/integration
COPY event_bus.py ./
COPY personas.py ./
COPY experiment_cli.py ./
COPY jupyter_connector.py ./
COPY audit.py ./
COPY api_server.py ./
COPY simulation_orchestrator.py ./
COPY command_processor.py ./
COPY alert_system.py ./
COPY trace_analyzer.py ./
COPY error_handler.py ./
COPY financial_audit.py ./
COPY ledger_utils.py ./
COPY sitecustomize.py ./

# Include local money library so runtime imports resolve
COPY money ./money
COPY events.py ./
# Include tests in the image so we can run pytest inside Docker

# Install the package and dependencies
RUN python -m pip install --upgrade pip setuptools wheel poetry-core && \
    pip install .

# Create a writable data dir for SQLite persistence
RUN mkdir -p /data

EXPOSE 8000

CMD ["uvicorn", "fba_bench_api.main:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers"]
