version: "3.9"

# Staging stack (production-like):
# - Mirrors docker-compose.prod.yml but reads environment from config/env/staging.env
# - TLS via nginx (mount certs to ./config/tls/server.crt|server.key)
services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: fba-bench-api:${API_IMAGE_TAG:-staging}
    env_file:
      - config/env/staging.env
    environment:
      # Allow environment overrides from CI/CD if present
      AUTH_ENABLED: "${AUTH_ENABLED:-true}"
      AUTH_TEST_BYPASS: "${AUTH_TEST_BYPASS:-false}"
      AUTH_PROTECT_DOCS: "${AUTH_PROTECT_DOCS:-true}"
      API_RATE_LIMIT: "${API_RATE_LIMIT:-100/minute}"
      FBA_CORS_ALLOW_ORIGINS: "${FBA_CORS_ALLOW_ORIGINS}"
      DATABASE_URL: "${DATABASE_URL}"
      FBA_BENCH_REDIS_URL: "${FBA_BENCH_REDIS_URL}"
      # JWT verification key mounted as a Docker secret (see top-level 'secrets')
      AUTH_JWT_PUBLIC_KEY_FILE: "/run/secrets/jwt_public_key"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop: ["ALL"]
    tmpfs:
      - /tmp:rw,noexec,nosuid,nodev
    ulimits:
      nofile:
        soft: 8192
        hard: 8192
    volumes:
      - api_data:/data
    secrets:
      - jwt_public_key
    depends_on:
      - redis
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.50"
          memory: 512M

  redis:
    image: redis:7-alpine
    command:
      - "redis-server"
      - "--appendonly"
      - "yes"
      - "--requirepass"
      - "${REDIS_PASSWORD:-ChangeMe_Redis_#v7An!2Yp}"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-ChangeMe_Redis_#v7An!2Yp}
    volumes:
      - redis_data:/data
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"$${REDIS_PASSWORD}\" ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 12
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 512M

  web:
    image: nginx:1.27-alpine
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/tls:/etc/nginx/ssl:ro
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop: ["ALL"]
    networks: [backend, public]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate -qO- https://localhost/nginx-health >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.10"
          memory: 128M

networks:
  backend:
    driver: bridge
  public:
    driver: bridge

volumes:
  api_data:
  redis_data:

secrets:
  jwt_public_key:
    file: ./config/secrets/jwt_public_key.pem