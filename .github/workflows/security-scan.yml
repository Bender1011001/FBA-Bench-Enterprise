name: Security Scan

on:
  push:
    branches: [ main, master, release/** ]
  pull_request:

permissions:
  contents: read

jobs:
  deps-security:
    name: Python dependency CVE scan (pip-audit & Safety)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install project dependencies (no dev extras)
        run: |
          poetry install --no-interaction --no-root

      - name: Install security scanners
        run: |
          python -m pip install --upgrade pip-audit safety

      - name: pip-audit (produce JSON)
        run: |
          pip-audit -f json -o pip_audit_report.json || true

      - name: Safety (produce JSON)
        run: |
          safety check --full-report --json > safety_report.json || true

      - name: Enforce severity gate (fail on Critical/High)
        run: |
          python - << 'PY'
          import json, sys
          ok = True
          highs = crits = 0

          try:
              with open('safety_report.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              ap = data.get('affected_packages') or {}
              for pkg, info in ap.items():
                  for v in info.get('vulnerabilities', []):
                      sev = (v.get('severity') or '').lower()
                      if sev == 'critical':
                          crits += 1
                      if sev == 'high':
                          highs += 1
          except Exception as e:
              print(f'[security-gate] Failed to parse safety report: {e}')
              ok = False

          print(f'[security-gate] Critical: {crits}  High: {highs}')
          if crits or highs:
              ok = False

          sys.exit(0 if ok else 1)
          PY

      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-artifacts
          path: |
            pip_audit_report.json
            safety_report.json