name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python project and dependencies
        run: |
          pip install -r requirements.txt
          pip install . # Installs the project for CI environment

      - name: Install linters and type checkers
        run: |
          pip install ruff mypy

      - name: Run backend tests
        run: pytest -q

      - name: Run ruff check
        run: ruff check .

      - name: Run mypy type checking
        run: mypy --ignore-missing-imports # As requested

  detect_frontend_apps:
    runs-on: ubuntu-latest
    needs: backend
    outputs:
      apps: ${{ steps.detect.outputs.apps }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect frontend apps with package.json
        id: detect
        run: |
          # Install jq if not already available on the runner
          if ! command -v jq &> /dev/null
          then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          APPS_JSON="[]"
          if [ -f "frontend/package.json" ]; then
            APPS_JSON=$(echo "$APPS_JSON" | jq -c '. += ["frontend"]')
          fi
          if [ -f "web/package.json" ]; then
            APPS_JSON=$(echo "$APPS_JSON" | jq -c '. += ["web"]')
          fi
          echo "Detected frontend apps: $APPS_JSON"
          echo "apps=${APPS_JSON}" >> $GITHUB_OUTPUT

  frontend_ci:
    runs-on: ubuntu-latest
    needs: detect_frontend_apps
    # Skip this job entirely if no frontend apps were detected
    if: ${{ needs.detect_frontend_apps.outputs.apps != '[]' }}
    strategy:
      matrix:
        # Dynamically set the matrix based on detected apps
        app: ${{ fromJson(needs.detect_frontend_apps.outputs.apps) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Node.js dependencies for ${{ matrix.app }}
        run: |
          echo "Setting up Node.js for app: ${{ matrix.app }}"
          cd ${{ matrix.app }}
          npm ci
          cd ..

      - name: Run tests for ${{ matrix.app }}
        run: |
          echo "Running tests for app: ${{ matrix.app }}"
          cd ${{ matrix.app }}
          npm run test --if-present -- --run # As requested
          cd ..

      - name: Build for ${{ matrix.app }}
        run: |
          echo "Building app: ${{ matrix.app }}"
          cd ${{ matrix.app }}
          npm run build --if-present
          cd ..
