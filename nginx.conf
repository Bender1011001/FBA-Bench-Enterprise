# Expose backend configuration via environment variables at the master (main) context.
# Operators can set these (e.g., in Docker) to override defaults.
env BACKEND_HOST;
env BACKEND_PORT;

worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout  65;
  # Configure client max body size - adjust based on application requirements
  client_max_body_size 20m;

  # Rate limiting zone for API
  limit_req_zone $binary_remote_addr zone=api_limit:10m rate=50r/m;

  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # Backend is internal uvicorn on localhost:8001
  upstream backend_api {
    server 127.0.0.1:8001;
  }

  # HTTP (80) -> HTTPS (443) redirect.
  # To disable for local development, comment out the return below.
  server {
    listen 80 default_server;
    # For production, set explicit server_name values (e.g., example.com www.example.com)
    # Default underscore '_' server name; override via templating or envsubst at deploy time
    server_name _;
    return 301 https://$host$request_uri;
  }

  # HTTPS server with SSL enabled. Mount certificates into /etc/nginx/ssl in deployment.
  server {
    listen 443 ssl http2;
    # For production, configure to explicit hostnames (e.g., example.com www.example.com).
    server_name _;

    # SSL certificate paths - set concrete defaults; override via templating during deployment if needed
    ssl_certificate     /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    # Basic health endpoint for the proxy itself
    location = /nginx-health {
      return 200 'OK';
      add_header Content-Type text/plain;
    }

    # Serve React frontend static files (SPA routing)
    location / {
      root /app/static;
      try_files $uri /index.html;
      add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # API reverse proxy with rate limiting
    location /api/ {
      limit_req zone=api_limit burst=100 nodelay;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://backend_api/api/;
      proxy_read_timeout 300;
      proxy_connect_timeout 60;
      proxy_send_timeout 60;
    }

    # Static assets cache
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
      root /app/static;
      expires 1y;
      add_header Cache-Control "public, immutable";
      access_log off;
    }

    # WebSocket proxy (backend must expose /ws/*)
    location /ws/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_pass http://backend_api/ws/;
      proxy_read_timeout 600s;
    }

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    # CSP for React app
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' ws: wss: https:;" always;

    # Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
      text/plain
      text/css
      text/xml
      text/javascript
      application/json
      application/javascript
      application/xml+rss
      application/atom+xml
      image/svg+xml;
  }
}
