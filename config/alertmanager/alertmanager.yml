# Alertmanager configuration with environment-expanded secrets.
# Ensure Alertmanager runs with config env expansion enabled or pre-process with envsubst:
#   - flag: --enable-feature=expand-env
#   - or:  envsubst < alertmanager.yml > alertmanager.expanded.yml
global:
  resolve_timeout: 5m
  smtp_smarthost: "${SMTP_SMARTHOST}"
  smtp_from: "${SMTP_FROM}"
  smtp_auth_username: "${SMTP_USERNAME}"
  smtp_auth_password: "${SMTP_PASSWORD}"

route:
  receiver: "null"
  group_by: ["alertname", "service", "slo", "severity"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  routes:
    # Critical production incidents
    - matchers:
        - severity="critical"
      receiver: "pagerduty"
      continue: true
    # Warnings to Slack
    - matchers:
        - severity="warning"
      receiver: "slack"
      continue: true
    # Fallback email for any unresolved alerts
    - receiver: "email"

inhibit_rules:
  # Inhibit warnings when a critical alert for same service/slo is firing
  - source_matchers: [ 'severity="critical"' ]
    target_matchers: [ 'severity="warning"' ]
    equal: ["service", "slo", "alertname"]

receivers:
  - name: "null"

  - name: "slack"
    slack_configs:
      - send_resolved: true
        api_url: "${SLACK_WEBHOOK_URL}"
        channel: "${SLACK_CHANNEL:#observability}"
        title: "{{ .CommonLabels.alertname }} ({{ .CommonLabels.severity }})"
        text: |-
          *Alert:* {{ .CommonLabels.alertname }} ({{ .CommonLabels.severity }})
          *Service:* {{ .CommonLabels.service }} | *SLO:* {{ .CommonLabels.slo }}
          *Environment:* {{ .CommonLabels.deployment_environment | default "unknown" }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *StartsAt:* {{ .CommonStartsAt }}
          *EndsAt:* {{ .CommonEndsAt }}
        http_config:
          tls_config:
            insecure_skip_verify: false

  - name: "pagerduty"
    pagerduty_configs:
      - routing_key: "${PAGERDUTY_ROUTING_KEY}"
        send_resolved: true
        class: "{{ .CommonLabels.service }}"
        severity: |-
          {{- if eq (index .CommonLabels "severity") "critical" -}}critical{{- else -}}error{{- end -}}
        component: "{{ .CommonLabels.alertname }}"
        group: '{{ .CommonLabels.slo | default "general" }}'
        details:
          description: "{{ .CommonAnnotations.description }}"
          summary: "{{ .CommonAnnotations.summary }}"
          environment: '{{ .CommonLabels.deployment_environment | default "unknown" }}'
          service: '{{ .CommonLabels.service | default "unknown" }}'

  - name: "email"
    email_configs:
      - to: "${ALERT_EMAIL_TO}"
        send_resolved: true
        html: |-
          <h3>{{ .CommonLabels.alertname }} ({{ .CommonLabels.severity }})</h3>
          <p><b>Service:</b> {{ .CommonLabels.service }} | <b>SLO:</b> {{ .CommonLabels.slo }}</p>
          <p><b>Environment:</b> {{ .CommonLabels.deployment_environment | default "unknown" }}</p>
          <p><b>Summary:</b> {{ .CommonAnnotations.summary }}</p>
          <p><b>Description:</b> {{ .CommonAnnotations.description }}</p>

templates:
  - "*.tmpl"